const Web3PromiEvent = require("web3-core-promievent");
const {
  getCurrentStack,
  encodeSolidityStackTrace
} = require("@nomiclabs/buidler/internal/buidler-evm/stack-traces/solidity-errors");

function PromiEvent() {
  const { resolve, reject, eventEmitter } = Web3PromiEvent.apply(
    null,
    arguments
  );

  const originalStackTrace = new Error().stack;
  const currentRawStackTrace = getCurrentStack();

  function rejectHijacker(e) {
    if (e.stackTrace !== undefined) {
      const error = encodeSolidityStackTrace(
        e.message,
        e.stackTrace,
        currentRawStackTrace.slice(2)
      );
      reject(error);
      return;
    }
    
    try {
      const stackTrace = originalStackTrace.replace(
        /^Error: \n/,
        e.stack.split("\n")[0]
      );

      e.hijackedStack = e.stack;
      e.stack = stackTrace;
    } catch (_) {
      // Ignore the case when the replacement fails
    }

    reject(e);
  }

  return {
    resolve,
    reject: rejectHijacker,
    eventEmitter
  };
}

PromiEvent.resolve = Web3PromiEvent.resolve;

module.exports = PromiEvent;